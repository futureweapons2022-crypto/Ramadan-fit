<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA & Mobile Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1e23">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23c5a059' d='M50 5 L93.3 30 V80 L50 105 L6.7 80 V30 Z'/%3E%3C/svg%3E">
    
    <!-- Inline Manifest for PWA Installability -->
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiUmFtYWRhbiBGaXQiLCJzaG9ydF9uYW1lIjoiUmFtYWRhbiBGaXQiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzFhMWUyMyIsInRoZW1lX2NvbG9yIjoiIzFhMWUyMyIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTI1M0NzdmclMjB4bWxucyUzRCUyN2h0dHAlM0ElMkYlMkZ3d3cudzMub3JnJTJGMjAwMCUyRnN2ZyUyNyUyMHZpZXdCb3glM0QlMjcwJTIwMCUyMDEwMCUyMDEwMCUyNyUyNSAzRSUyNTNDcGF0aCUyMGZpbGwlM0QlMjclMjNjNWEwNTklMjclMjBkM0QlMjdNNTAlMjA1JTIwTDkzLjMlMjAzMCUyMFY4MCUyMEw1MCUyMDEwNSUyMEw2LjclMjA4MCUyMFYzMCUyMFolMjclMkYlMjUzRSUyNTNDJTJGc3ZnJTI1M0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0='>

    <title>Ramadan Mode | Elite Fitness Tracker</title>
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-dark: #1a1e23;
            --bg-panel: #242930;
            --primary: #c5a059; /* Gold */
            --primary-hover: #d4b06a;
            --text-main: #f0f0f0;
            --text-muted: #a0a0a0;
            --danger: #e74c3c;
            --success: #27ae60;
            --water: #3498db;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-stack);
            line-height: 1.6;
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(197, 160, 89, 0.03) 0%, transparent 60%),
                repeating-linear-gradient(45deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 10px),
                repeating-linear-gradient(-45deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 10px);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overscroll-behavior-y: none; /* Disables pull-to-refresh on mobile */
        }

        /* --- INTRO ANIMATION (PREMIUM FEEL) --- */
        #view-intro {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .intro-logo-container {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 0;
            transform: scale(0.8);
            animation: logoReveal 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            animation-delay: 0.5s;
        }
        
        .intro-title {
            font-size: 2rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: 700;
            opacity: 0;
            transform: translateY(20px);
            animation: textReveal 1s ease-out forwards;
            animation-delay: 1.2s;
        }

        .intro-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 10px;
            opacity: 0;
            animation: textReveal 1s ease-out forwards;
            animation-delay: 1.8s;
        }

        .intro-progress {
            width: 200px;
            height: 2px;
            background: rgba(255,255,255,0.1);
            margin-top: 40px;
            position: relative;
            overflow: hidden;
            opacity: 0;
            animation: textReveal 0.5s ease forwards;
            animation-delay: 2.2s;
        }

        .intro-progress-bar {
            position: absolute;
            left: 0; top: 0; height: 100%;
            background: var(--primary);
            width: 0%;
            animation: progressLoad 2s ease-in-out forwards;
            animation-delay: 2.3s;
        }

        @keyframes logoReveal { to { opacity: 1; transform: scale(1); } }
        @keyframes textReveal { to { opacity: 1; transform: translateY(0); } }
        @keyframes progressLoad { from { width: 0%; } to { width: 100%; } }
        @keyframes fadeOutIntro { to { opacity: 0; visibility: hidden; } }

        /* --- LAYOUT --- */
        .app-container {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            padding-bottom: 90px;
            flex: 1;
            position: relative;
        }

        /* --- BRANDING HEADER --- */
        .brand-header {
            background: linear-gradient(135deg, #2c3e50, #1a1e23);
            border-bottom: 2px solid var(--primary);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
        }
        .brand-header::after {
            content: '';
            position: absolute;
            right: -20px;
            top: -20px;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(197, 160, 89, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .app-logo { width: 48px; height: 48px; fill: var(--primary); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .brand-text h1 { font-weight: 700; letter-spacing: 1.5px; color: var(--primary); font-size: 1.4rem; margin: 0; line-height: 1.2; text-transform: uppercase; }
        .brand-text span { font-size: 0.75rem; color: var(--text-muted); font-weight: 400; letter-spacing: 2px; text-transform: uppercase; }

        /* --- NAVIGATION --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-panel);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid rgba(255,255,255,0.05);
            z-index: 100;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            background: none;
            border: none;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
        .nav-item.active { color: var(--primary); }

        /* --- COMPONENTS --- */
        .card {
            background: var(--bg-panel);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.03);
        }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }
        
        button { cursor: pointer; font-family: inherit; }
        .btn-primary {
            background: var(--primary);
            color: var(--bg-dark);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            width: 100%;
            transition: background 0.2s;
            font-size: 1rem;
        }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 6px;
        }
        input, select, textarea {
            width: 100%;
            background: #15181c;
            border: 1px solid #333;
            color: var(--text-main);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }

        /* --- DASHBOARD SPECIFIC --- */
        .stat-circle {
            width: 100px; height: 100px;
            border-radius: 50%;
            border: 4px solid var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin: 0 auto;
            position: relative;
            background: conic-gradient(var(--primary) var(--pct), rgba(255,255,255,0.1) 0);
        }
        .stat-circle-inner {
            width: 84px; height: 84px;
            background: var(--bg-panel);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); }

        /* --- HYDRATION --- */
        .water-tracker { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
        .glass {
            width: 40px; height: 50px;
            border: 2px solid var(--text-muted);
            border-radius: 0 0 8px 8px;
            position: relative;
            cursor: pointer;
            transition: 0.2s;
        }
        .glass.filled { background: var(--water); border-color: var(--water); }

        /* --- MEAL PLANNER --- */
        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
        .progress-fill.warning { background: var(--danger); }
        .food-item {
            display: flex; justify-content: space-between; padding: 10px;
            background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 8px; font-size: 0.9rem;
        }

        /* --- WORKOUT --- */
        .workout-tag {
            display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;
            background: rgba(197, 160, 89, 0.2); color: var(--primary); margin-right: 5px;
        }

        /* --- PRAYER TIMES --- */
        .prayer-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        .prayer-row.next { color: var(--primary); font-weight: bold; border-color: var(--primary); }
        .countdown-box {
            text-align: center; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;
            margin-bottom: 15px; border: 1px solid var(--primary);
        }
        .countdown-time { font-size: 2rem; font-weight: bold; font-family: monospace; color: var(--primary); }
        
        /* --- INSTALL GUIDE MODAL --- */
        #install-modal {
            position: fixed; bottom: 0; left: 0; width: 100%; height: auto;
            background: #2c3e50; border-top: 2px solid var(--primary);
            z-index: 5000; padding: 20px;
            transform: translateY(100%); transition: transform 0.4s ease-out;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
        }
        #install-modal.show { transform: translateY(0); }
        .install-content { display: flex; align-items: flex-start; gap: 15px; }
        .install-icon { font-size: 2rem; }
        .install-text h3 { color: var(--primary); margin-bottom: 5px; font-size: 1rem; text-transform: uppercase; }
        .install-text p { font-size: 0.85rem; color: #fff; margin-bottom: 10px; }
        .install-close { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #fff; font-size: 1.5rem; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .flex-between { display: flex; justify-content: space-between; }
        .badge { background: var(--primary); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>
<body>

    <!-- 1. PREMIUM INTRO SPLASH -->
    <section id="view-intro" class="hidden">
        <div class="intro-logo-container">
            <svg viewBox="0 0 100 100" style="width:100%; height:100%; fill:var(--primary);">
                <path d="M50 5 L93.3 30 V80 L50 105 L6.7 80 V30 Z" />
                <path d="M50 20 L75 85 L20 45 H80 L25 85 Z" fill="#1a1e23"/>
            </svg>
        </div>
        <div class="intro-title">Ramadan Mode</div>
        <div class="intro-subtitle">Elite Fitness Intelligence</div>
        <div class="intro-progress">
            <div class="intro-progress-bar"></div>
        </div>
    </section>

    <!-- 2. INSTALL GUIDE POPUP -->
    <div id="install-modal">
        <button class="install-close" onclick="closeInstallModal()">&times;</button>
        <div class="install-content">
            <div class="install-icon">üì≤</div>
            <div class="install-text">
                <h3>Install App</h3>
                <p id="install-instructions">For the best experience, add this app to your home screen.</p>
                <button class="btn-outline" style="padding: 5px 10px; font-size: 0.7rem;" onclick="closeInstallModal()">Got it</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="app">
        <!-- BRAND HEADER -->
        <div class="brand-header">
            <div class="logo-area">
                <svg class="app-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 5 L93.3 30 V80 L50 105 L6.7 80 V30 Z" fill="none" stroke="currentColor" stroke-width="4" />
                    <path d="M50 20 L75 85 L20 45 H80 L25 85 Z" fill="none" stroke="currentColor" stroke-width="2" opacity="0.8"/>
                    <circle cx="50" cy="55" r="5" fill="currentColor"/>
                </svg>
                <div class="brand-text">
                    <h1>Ramadan<br>Mode</h1>
                    <span>Elite Fitness Tracker</span>
                </div>
            </div>
            <div id="ramadan-day-badge" class="badge">DAY 1</div>
        </div>
        <div id="date-display" style="text-align: right; font-size: 0.8rem; color: var(--text-muted); margin-top: -15px; margin-bottom: 15px; padding-right: 5px;">Loading...</div>

        <!-- ONBOARDING WIZARD -->
        <section id="view-onboarding" class="hidden">
            <div style="text-align:center; margin-bottom:30px; margin-top:20px;">
                <h1 style="color:var(--primary); font-size:2rem;">Welcome</h1>
                <p style="color:var(--text-muted);">Let's personalize your Ramadan strategy.</p>
            </div>
            
            <form id="onboarding-form">
                <div class="card">
                    <h2>Location (Required)</h2>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">Accurate prayer times require your location.</p>
                    <div class="grid-2">
                        <div><label>Latitude</label><input type="number" id="ob-lat" step="any" placeholder="e.g. 25.346" required></div>
                        <div><label>Longitude</label><input type="number" id="ob-lng" step="any" placeholder="e.g. 55.420" required></div>
                    </div>
                    <button type="button" class="btn-outline" style="width:100%; margin-bottom:10px;" onclick="locateMeOnboarding()">üìç Detect My Location</button>
                </div>

                <div class="card">
                    <h2>Physical Stats</h2>
                    <div class="grid-2">
                        <div><label>Gender</label><select id="ob-gender"><option value="male">Male</option><option value="female">Female</option></select></div>
                        <div><label>Age</label><input type="number" id="ob-age" placeholder="25" required></div>
                    </div>
                    <div class="grid-2">
                        <div><label>Height (cm)</label><input type="number" id="ob-height" placeholder="175" required></div>
                        <div><label>Weight (kg)</label><input type="number" id="ob-weight" placeholder="75" required></div>
                    </div>
                </div>

                <div class="card">
                    <h2>Activity & Goals</h2>
                    <label>Activity Level</label>
                    <select id="ob-activity">
                        <option value="1.2">Sedentary (Office Job)</option>
                        <option value="1.375">Lightly Active (1-3 days/week)</option>
                        <option value="1.55">Moderately Active (3-5 days/week)</option>
                        <option value="1.725">Very Active (6-7 days/week)</option>
                    </select>

                    <label>Ramadan Goal</label>
                    <select id="ob-goal">
                        <option value="-500">Lose Fat (Deficit)</option>
                        <option value="0">Maintain Weight</option>
                        <option value="250">Build Muscle (Surplus)</option>
                    </select>
                </div>

                <button type="submit" class="btn-primary" style="padding: 15px; font-size: 1.1rem;">Calculate Plan & Start</button>
            </form>
        </section>

        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard" class="view hidden">
            <!-- PRAYER TIMES CARD -->
            <div class="card">
                <div class="flex-between" style="margin-bottom:10px;">
                    <h2>Fasting Status</h2>
                    <span id="fasting-status-badge" class="badge" style="background:var(--success); color:#fff;">EATING</span>
                </div>

                <div class="countdown-box">
                    <div style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;" id="countdown-label">TIME TO NEXT PRAYER</div>
                    <div class="countdown-time" id="countdown-timer">--:--:--</div>
                </div>

                <div id="prayer-list"></div>
                <div style="text-align:center; margin-top:10px; font-size:0.7rem; color:var(--text-muted);">
                    <span id="location-display">Location: --</span>
                </div>
            </div>

            <div class="card">
                <h2>Today's Summary</h2>
                <div class="grid-2">
                    <div class="text-center">
                        <div class="stat-circle" id="dash-cal-circle" style="--pct: 0%;">
                            <div class="stat-circle-inner">
                                <span class="stat-val" id="dash-cals">0</span>
                                <span class="stat-label">kCal</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="stat-circle" id="dash-water-circle" style="--pct: 0%; --primary: var(--water);">
                            <div class="stat-circle-inner">
                                <span class="stat-val" id="dash-water">0</span>
                                <span class="stat-label">Liters</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; display:flex; justify-content:space-between; align-items:center;">
                    <span>Workout Status:</span>
                    <span id="dash-workout-status" style="color: var(--text-muted);">Rest Day</span>
                </div>
                <div style="margin-top: 5px; display:flex; justify-content:space-between; align-items:center;">
                    <span>Energy Level:</span>
                    <span id="dash-energy" style="color: var(--primary);">--/10</span>
                </div>
            </div>

            <div class="card">
                <h2>Quick Actions</h2>
                <div class="grid-2">
                    <button class="btn-primary" onclick="navTo('view-log-workout')">Log Workout</button>
                    <button class="btn-primary" onclick="navTo('view-log-meal')">Log Meal</button>
                </div>
                <div style="margin-top:15px">
                     <button class="btn-outline" style="width:100%" onclick="quickAddWater()">+ 250ml Water</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Daily Tip</h2>
                <p id="daily-tip-text" style="font-size:0.9rem; color: var(--text-muted); font-style:italic;">Loading tip...</p>
            </div>
        </section>

        <!-- WORKOUT VIEW -->
        <section id="view-log-workout" class="view hidden">
            <div class="card">
                <h2>Log Workout</h2>
                <div style="margin-bottom: 15px; font-size: 0.8rem; color: var(--success);" id="workout-time-tip">
                    ‚ÑπÔ∏è Recommended: Train 1-2 hours after Iftar.
                </div>
                <form id="workout-form">
                    <label>Type</label>
                    <select id="w-type">
                        <option value="Strength">Strength Training</option>
                        <option value="Cardio">Cardio</option>
                        <option value="Mobility">Mobility/Stretching</option>
                        <option value="Sport">Sport</option>
                    </select>

                    <label>Duration (mins)</label>
                    <input type="number" id="w-duration" placeholder="45">

                    <label>Exercises</label>
                    <select id="w-exercise-select" onchange="addExerciseToText(this.value)">
                        <option value="">-- Quick Select --</option>
                        <option value="Squats">Squats</option>
                        <option value="Deadlifts">Deadlifts</option>
                        <option value="Bench Press">Bench Press</option>
                        <option value="Pushups">Pushups</option>
                        <option value="Lunges">Lunges</option>
                        <option value="Plank">Plank</option>
                        <option value="Treadmill">Treadmill Run</option>
                    </select>
                    <textarea id="w-notes" rows="3" placeholder="Details..."></textarea>
                    
                    <label>Energy Level (1-10)</label>
                    <input type="range" id="w-energy" min="1" max="10" value="5" oninput="document.getElementById('energy-val').innerText = this.value">
                    <div class="text-center" id="energy-val" style="margin-bottom:15px; color:var(--primary)">5</div>

                    <button type="submit" class="btn-primary">Save Workout</button>
                </form>
            </div>

            <div class="card">
                <h2>Recent Workouts</h2>
                <div id="workout-history-list"></div>
            </div>
        </section>

        <!-- MEALS VIEW -->
        <section id="view-log-meal" class="view hidden">
            <div class="card">
                <div class="flex-between">
                    <h2>Nutrition</h2>
                    <span id="cuisine-badge" class="badge" style="height: fit-content;">Global</span>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <div class="flex-between"><small>Calories</small> <small><span id="prog-cal-val">0</span> / <span id="target-cal">2000</span></small></div>
                    <div class="progress-bar"><div id="prog-cal" class="progress-fill" style="width: 0%"></div></div>
                    
                    <div class="flex-between"><small>Protein</small> <small><span id="prog-prot-val">0</span> / <span id="target-prot">150</span>g</small></div>
                    <div class="progress-bar"><div id="prog-prot" class="progress-fill" style="background: #9b59b6; width: 0%"></div></div>
                </div>

                <h3>Quick Add (<span id="active-cuisine-name">General</span>)</h3>
                <div id="food-suggestions" style="display:flex; overflow-x:auto; gap:10px; padding-bottom:10px; margin-bottom:15px;"></div>

                <form id="meal-form">
                    <div class="grid-2">
                        <select id="m-type">
                            <option value="Suhoor">Suhoor</option>
                            <option value="Iftar">Iftar</option>
                            <option value="Dinner">Dinner</option>
                            <option value="Snack">Snack</option>
                        </select>
                        <input type="text" id="m-name" placeholder="Food item name">
                    </div>
                    <div class="grid-2">
                        <input type="number" id="m-cals" placeholder="Cals">
                        <input type="number" id="m-prot" placeholder="Prot (g)">
                    </div>
                    <button type="submit" class="btn-primary">Add Meal</button>
                </form>
            </div>

            <div class="card">
                <h2>Today's Log</h2>
                <div id="meal-log-list"></div>
            </div>
        </section>

        <!-- HYDRATION VIEW -->
        <section id="view-hydration" class="view hidden">
            <div class="card text-center">
                <h2>Hydration Tracker</h2>
                <p style="color:var(--text-muted); margin-bottom:20px;">Window: Iftar to Suhoor</p>
                <div style="font-size:3rem; color:var(--water); font-weight:bold; margin-bottom:10px;">
                    <span id="hydro-liters">0.0</span> <span style="font-size:1rem;">L</span>
                </div>
                <p style="margin-bottom:20px;">Target: <span id="hydro-target">3.0</span> L</p>
                <div class="water-tracker" id="water-glasses"></div>
                <div style="margin-top:20px;">
                    <button class="btn-outline" onclick="resetWater()" style="border-color:var(--danger); color:var(--danger);">Reset Daily</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Hydration Tips</h2>
                <ul style="padding-left:20px; color:var(--text-muted); font-size:0.9rem;">
                    <li>Break fast with water and dates.</li>
                    <li>Sip small amounts frequently, don't chug.</li>
                    <li>Avoid sugary sodas.</li>
                </ul>
            </div>
        </section>

        <!-- STATS VIEW -->
        <section id="view-stats" class="view hidden">
            <div class="card">
                <h2>Progress Tracker</h2>
                <label>Update Weight (kg)</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="s-weight-input" placeholder="e.g. 75.5">
                    <button class="btn-primary" style="width:auto;" onclick="logWeight()">Log</button>
                </div>
                <div id="weight-history" style="margin-top:15px; font-size:0.9rem; color:var(--text-muted);"></div>
            </div>

            <div class="card">
                <h2>Ramadan Calendar</h2>
                <div id="calendar-grid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap:5px; text-align:center; font-size:0.8rem;"></div>
            </div>

            <div class="card">
                <h2>Data Management</h2>
                <button class="btn-outline" onclick="exportData()">Export Data (JSON)</button>
                <button class="btn-outline" style="border-color:var(--danger); color:var(--danger); margin-top:10px;" onclick="clearData()">Factory Reset</button>
            </div>
        </section>

        <!-- SETTINGS VIEW -->
        <section id="view-settings" class="view hidden">
            <div class="card">
                <h2>Settings</h2>
                
                <div class="settings-group">
                    <h3>Ramadan Start Date</h3>
                    <input type="date" id="setting-start-date">
                </div>

                <div class="settings-group">
                    <h3>Location for Prayer Times</h3>
                    <div class="grid-2">
                        <div><label>Latitude</label><input type="number" id="setting-lat" step="any"></div>
                        <div><label>Longitude</label><input type="number" id="setting-lng" step="any"></div>
                    </div>
                    <button class="btn-outline" style="width:100%" onclick="locateMe()">üìç Locate Me (GPS)</button>
                </div>
                
                <div class="settings-group">
                    <h3>Calculation Method</h3>
                    <select id="setting-calc-method">
                        <option value="MWL">Muslim World League</option>
                        <option value="ISNA">ISNA (North America)</option>
                        <option value="Egypt">Egyptian General Authority</option>
                        <option value="Makkah">Umm Al-Qura (Makkah)</option>
                        <option value="Karachi">Univ. Islamic Sciences, Karachi</option>
                        <option value="Tehran">Tehran</option>
                    </select>
                </div>

                <div class="settings-group">
                    <h3>Goals (Auto-Calculated)</h3>
                    <div class="grid-2">
                        <div><label>Calorie Target</label><input type="number" id="setting-cal-target"></div>
                        <div><label>Protein Target (g)</label><input type="number" id="setting-prot-target"></div>
                    </div>
                </div>

                <div class="settings-group">
                    <h3>Edition</h3>
                    <p style="color: var(--primary);">Full Gumroad Edition</p>
                    <p style="font-size:0.8rem; color:var(--text-muted);">Thank you for supporting independent development.</p>
                </div>

                <button class="btn-primary" onclick="saveSettings()">Save Changes</button>
            </div>
        </section>

    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="navTo('view-dashboard')">
            <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>Dashboard
        </button>
        <button class="nav-item" onclick="navTo('view-log-workout')">
            <svg viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 17 22.71 22 17.71z"/></svg>Workout
        </button>
        <button class="nav-item" onclick="navTo('view-log-meal')">
            <svg viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>Meals
        </button>
        <button class="nav-item" onclick="navTo('view-hydration')">
            <svg viewBox="0 0 24 24"><path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8zm0 18c-3.35 0-6-2.57-6-6.2 0-2.34 1.95-5.44 6-9.14 4.05 3.7 6 6.8 6 9.14 0 3.63-2.65 6.2-6 6.2z"/></svg>Water
        </button>
        <button class="nav-item" onclick="navTo('view-stats')">
            <svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>Stats
        </button>
        <button class="nav-item" onclick="navTo('view-settings')">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>Settings
        </button>
    </nav>

    <script>
        // --- PRAYER TIMES ENGINE (Standard Offline Version) ---
        class PrayTimes {
            constructor(methodId) {
                // Calculation Methods
                this.methods = {
                    MWL: { name: 'Muslim World League', params: { fajr: 18, isha: 17 } },
                    ISNA: { name: 'ISNA', params: { fajr: 15, isha: 15 } },
                    Egypt: { name: 'Egypt', params: { fajr: 19.5, isha: 17.5 } },
                    Makkah: { name: 'Makkah', params: { fajr: 18.5, isha: 90 } }, // isha fixed 90m
                    Karachi: { name: 'Karachi', params: { fajr: 18, isha: 18 } },
                    Tehran: { name: 'Tehran', params: { fajr: 17.7, isha: 14, maghrib: 4.5, midnight: 'Jafari' } },
                };
                this.calcMethod = this.methods[methodId] ? this.methods[methodId] : this.methods['MWL'];
                this.setting = {
                    imsak: '10 min',
                    dhuhr: '0 min',
                    asr: 'Standard',
                    highLats: 'NightMiddle'
                };
                this.timeNames = ['fajr', 'sunrise', 'dhuhr', 'asr', 'sunset', 'maghrib', 'isha'];
            }

            setMethod(methodId) {
                if(this.methods[methodId]) this.calcMethod = this.methods[methodId];
            }

            setAsrMethod(methodId) {
                this.setting.asr = methodId; // Standard or Hanafi
            }

            // Math Functions
            dtr(d) { return (d * Math.PI) / 180.0; }
            rtd(r) { return (r * 180.0) / Math.PI; }
            sin(d) { return Math.sin(this.dtr(d)); }
            cos(d) { return Math.cos(this.dtr(d)); }
            tan(d) { return Math.tan(this.dtr(d)); }
            arcsin(d) { return this.rtd(Math.asin(d)); }
            arccos(d) { return this.rtd(Math.acos(d)); }
            arctan(d) { return this.rtd(Math.atan(d)); }
            arccot(x) { return this.rtd(Math.atan(1.0 / x)); }
            arctan2(y, x) { return this.rtd(Math.atan2(y, x)); }

            fixHour(a) { a = a - 24.0 * Math.floor(a / 24.0); a = a < 0 ? a + 24.0 : a; return a; }

            // Sun Position
            sunPosition(jd) {
                const D = jd - 2451545.0;
                const g = this.fixHour(357.529 + 0.98560028 * D);
                const q = this.fixHour(280.459 + 0.98564736 * D);
                const L = this.fixHour(q + 1.915 * this.sin(g) + 0.020 * this.sin(2 * g));
                const e = 23.439 - 0.00000036 * D;
                const RA = this.arctan2(this.cos(e) * this.sin(L), this.cos(L)) / 15.0;
                const eqt = q / 15.0 - this.fixHour(RA);
                const decl = this.arcsin(this.sin(e) * this.sin(L));
                return { decl: decl, eqt: eqt };
            }

            // Time Calculation
            computeTime(G, decl, lat) {
                const D = this.sin(decl), L = this.sin(lat), R = this.cos(decl) * this.cos(lat);
                const V = (this.sin(-G) - D * L) / R;
                return this.arccos(V) / 15.0;
            }

            // Main Get Times
            getTimes(date, lat, lng, timeZone) {
                const jd = this.julian(date.getFullYear(), date.getMonth() + 1, date.getDate());
                const sp = this.sunPosition(jd - lng / (15 * 24));
                const times = { imsak: 5, fajr: 5, sunrise: 6, dhuhr: 12, asr: 13, sunset: 18, maghrib: 18, isha: 18 };
                
                // Params
                const p = this.calcMethod.params;
                
                // Dhuhr
                times.dhuhr = 12 + sp.eqt - lng / 15;

                // Sunrise/Sunset (angle 0.833)
                const sunAngle = 0.833;
                const riseSet = this.computeTime(sunAngle, sp.decl, lat);
                times.sunrise = times.dhuhr - riseSet;
                times.sunset = times.dhuhr + riseSet;

                // Fajr
                times.fajr = times.dhuhr - this.computeTime(p.fajr, sp.decl, lat);

                // Asr
                const shadowLength = this.setting.asr === 'Hanafi' ? 2 : 1;
                const asrAngle = -this.arccot(shadowLength + this.tan(Math.abs(lat - sp.decl)));
                times.asr = times.dhuhr + this.computeTime(Math.abs(asrAngle), sp.decl, lat);

                // Maghrib
                if(p.maghrib) times.maghrib = times.sunset + p.maghrib / 60; // Fixed minutes?
                else times.maghrib = times.sunset + this.computeTime(p.maghrib ? p.maghrib : 0.833, sp.decl, lat); // Or angle (Tehran uses 4.5)

                // Isha
                if(this.calcMethod.name === 'Makkah') times.isha = times.maghrib + 1.5; // 90 mins
                else if (typeof p.isha === 'number' && p.isha < 12) times.isha = times.dhuhr + this.computeTime(p.isha, sp.decl, lat); // Angle
                else times.isha = times.maghrib + (p.isha || 0) / 60; // Fixed Min (fallback)

                // Formatting
                const result = {};
                this.timeNames.forEach(n => {
                    // Timezone correction
                    let t = times[n] + timeZone - lng / 15;
                    t = this.fixHour(t);
                    // Convert to Hours:Minutes
                    const hours = Math.floor(t);
                    const minutes = Math.floor((t - hours) * 60);
                    const suffix = hours >= 12 ? ' PM' : ' AM';
                    const h12 = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
                    const mStr = minutes < 10 ? '0' + minutes : minutes;
                    result[n] = {
                        raw: t, // Keep raw float for calculation
                        display: `${h12}:${mStr}${suffix}`
                    };
                });
                return result;
            }

            julian(year, month, day) {
                if (month <= 2) { year -= 1; month += 12; }
                const A = Math.floor(year / 100);
                const B = 2 - A + Math.floor(A / 4);
                return Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + B - 1524.5;
            }
        }

        // --- CONSTANTS & DATA ---
        
        const CUISINE_DATA = {
            'middle_eastern': [
                {name: 'Dates (3)', cals: 60, prot: 1},
                {name: 'Lentil Soup (1 bowl)', cals: 180, prot: 12},
                {name: 'Hummus (2 tbsp)', cals: 70, prot: 2},
                {name: 'Grilled Chicken (150g)', cals: 250, prot: 35},
                {name: 'Fattoush Salad', cals: 150, prot: 3},
                {name: 'Falafel (3)', cals: 170, prot: 9},
                {name: 'Shish Tawook (1 skewer)', cals: 200, prot: 22},
                {name: 'Labneh (2 tbsp)', cals: 60, prot: 3},
                {name: 'Kibbeh (1)', cals: 180, prot: 8},
                {name: 'Foul Medames (1 cup)', cals: 250, prot: 14},
                {name: 'Shakshuka (1 serving)', cals: 220, prot: 12},
                {name: 'Kofta (2 pcs)', cals: 280, prot: 18},
                {name: 'Sambousek (Cheese)', cals: 130, prot: 4},
                {name: 'Baklava (1 small)', cals: 100, prot: 1},
                {name: 'Harees (1 bowl)', cals: 300, prot: 20}
            ],
            'south_asian': [
                {name: 'Dates (3)', cals: 60, prot: 1},
                {name: 'Fruit Chaat', cals: 120, prot: 2},
                {name: 'Chicken Biryani (1 cup)', cals: 350, prot: 15},
                {name: 'Chana Chaat', cals: 200, prot: 8},
                {name: 'Seekh Kebab (1)', cals: 150, prot: 12},
                {name: 'Haleem (1 bowl)', cals: 400, prot: 25},
                {name: 'Samosa (1)', cals: 140, prot: 3},
                {name: 'Pakora (3)', cals: 180, prot: 4},
                {name: 'Chapati (1)', cals: 100, prot: 3},
                {name: 'Daal (1 bowl)', cals: 160, prot: 10},
                {name: 'Keema (100g)', cals: 250, prot: 20},
                {name: 'Palak Paneer', cals: 280, prot: 12},
                {name: 'Tandoori Chicken (leg)', cals: 220, prot: 28},
                {name: 'Ras Malai (1)', cals: 180, prot: 4},
                {name: 'Aloo Gobi', cals: 150, prot: 3}
            ],
            'southeast_asian': [
                {name: 'Dates (3)', cals: 60, prot: 1},
                {name: 'Bubur Lambuk', cals: 250, prot: 10},
                {name: 'Beef Rendang (small)', cals: 300, prot: 18},
                {name: 'Nasi Lemak (half)', cals: 400, prot: 12},
                {name: 'Soy Milk', cals: 100, prot: 8},
                {name: 'Chicken Satay (3 sticks)', cals: 180, prot: 15},
                {name: 'Laksa (small bowl)', cals: 350, prot: 15},
                {name: 'Roti Canai (1)', cals: 300, prot: 5},
                {name: 'Murtabak (1 slice)', cals: 250, prot: 12},
                {name: 'Mee Goreng (small)', cals: 380, prot: 10},
                {name: 'Spring Rolls (2)', cals: 150, prot: 4},
                {name: 'Gado Gado', cals: 220, prot: 8},
                {name: 'Kolak (1 cup)', cals: 250, prot: 2},
                {name: 'Soto Ayam (no rice)', cals: 200, prot: 15},
                {name: 'Nasi Goreng (1 cup)', cals: 350, prot: 10}
            ],
            'western': [
                {name: 'Dates (3)', cals: 60, prot: 1},
                {name: 'Oatmeal (1 cup)', cals: 150, prot: 5},
                {name: 'Grilled Salmon', cals: 300, prot: 30},
                {name: 'Protein Shake', cals: 120, prot: 24},
                {name: 'Avocado Toast', cals: 250, prot: 6},
                {name: 'Scrambled Eggs (2)', cals: 140, prot: 12},
                {name: 'Greek Yogurt Parfait', cals: 200, prot: 15},
                {name: 'Grilled Steak (150g)', cals: 350, prot: 40},
                {name: 'Caesar Salad (w/ chicken)', cals: 350, prot: 25},
                {name: 'Tuna Sandwich', cals: 300, prot: 20},
                {name: 'Protein Pancakes', cals: 250, prot: 15},
                {name: 'Roast Chicken Breast', cals: 165, prot: 31},
                {name: 'Sweet Potato (baked)', cals: 110, prot: 2},
                {name: 'Cottage Cheese (1 cup)', cals: 220, prot: 25},
                {name: 'Smoothie Bowl', cals: 250, prot: 5}
            ],
            'mediterranean': [
                {name: 'Dates (3)', cals: 60, prot: 1},
                {name: 'Greek Yogurt', cals: 100, prot: 10},
                {name: 'Falafel (3)', cals: 170, prot: 9},
                {name: 'Quinoa Salad', cals: 220, prot: 8},
                {name: 'Grilled Fish', cals: 200, prot: 25},
                {name: 'Greek Salad', cals: 150, prot: 5},
                {name: 'Moussaka (small)', cals: 350, prot: 15},
                {name: 'Chicken Souvlaki', cals: 250, prot: 25},
                {name: 'Tzatziki (2 tbsp)', cals: 50, prot: 2},
                {name: 'Pita Bread (1)', cals: 160, prot: 5},
                {name: 'Dolma (3)', cals: 120, prot: 2},
                {name: 'Spanakopita', cals: 250, prot: 6},
                {name: 'Roasted Veggies', cals: 100, prot: 3},
                {name: 'Grilled Halloumi (2)', cals: 200, prot: 12},
                {name: 'Lentil Soup', cals: 180, prot: 12}
            ],
            'african': [
                {name: 'Dates (3)', cals: 60, prot: 1},
                {name: 'Harira Soup', cals: 250, prot: 15},
                {name: 'Jollof Rice', cals: 300, prot: 6},
                {name: 'Moi Moi', cals: 150, prot: 10},
                {name: 'Grilled Tilapia', cals: 200, prot: 25},
                {name: 'Fufu (small)', cals: 300, prot: 2},
                {name: 'Egusi Soup', cals: 350, prot: 15},
                {name: 'Beef Suya (2 sticks)', cals: 250, prot: 25},
                {name: 'Couscous (1 cup)', cals: 170, prot: 6},
                {name: 'Chicken Tagine', cals: 350, prot: 25},
                {name: 'Mandazi (1)', cals: 150, prot: 3},
                {name: 'Kachumbari', cals: 80, prot: 2},
                {name: 'Beef Pilau', cals: 400, prot: 20},
                {name: 'Bunny Chow (quarter)', cals: 500, prot: 20},
                {name: 'Injera (1)', cals: 120, prot: 4}
            ]
        };

        const TIPS_DB = [
            "Hydrate slowly between Iftar and Suhoor to avoid bloating.",
            "Prioritize sleep after Isha/Taraweeh to recover for Suhoor.",
            "Focus on compound movements like squats and pushups to maintain mass.",
            "If you feel dizzy during the day, skip the workout and rest.",
            "Fiber at Suhoor prevents hunger pangs during the day.",
            "Consistency > Intensity during Ramadan.",
            "Take a 20 min nap (Qailulah) in the afternoon to boost energy.",
            "Avoid salty foods at Suhoor to reduce thirst."
        ];

        // --- STATE MANAGEMENT ---
        let appState = {
            settings: {
                startDate: '2026-02-17', // Default predicted date
                cuisine: 'middle_eastern',
                calTarget: 2000,
                protTarget: 140,
                // Removed License Keys for Gumroad Edition
                lat: null, // Force user to set this
                lng: null,
                calcMethod: 'Makkah',
                asrMethod: 'Standard'
            },
            user: {
                onboarded: false,
                gender: 'male',
                age: 25,
                height: 175,
                weight: 75,
                activity: 1.2,
                goal: 0
            },
            logs: {
                meals: [],
                workouts: [],
                weight: []
            },
            dailyWater: 0 // Liters
        };

        let currentPrayerTimes = null;
        let countdownInterval = null;

        // --- INIT ---
        function init() {
            // Load from local storage
            const saved = localStorage.getItem('ramadanFitData');
            
            // INTRO LOGIC: Only show if session is fresh (simple check)
            // Ideally we show intro on first load of the session
            const sessionIntro = sessionStorage.getItem('introShown');

            if (saved) {
                appState = JSON.parse(saved);
                
                // If returning user, skip intro unless requested? 
                // Let's show intro only if not seen in this tab session for premium feel
                if (!sessionIntro) {
                    playIntro(false);
                } else {
                    document.getElementById('view-dashboard').classList.remove('hidden');
                }
            } else {
                // New User: Always play intro, then onboarding
                if (!sessionIntro) {
                    playIntro(true);
                } else {
                    // Check if onboarding needed
                    if(!appState.user.onboarded) {
                         setupOnboardingUI();
                    }
                }
            }
            
            // Check PWA Status
            checkInstallPrompt();

            // Default fallback for legacy data
            if(!appState.user) appState.user = { onboarded: false };
            if(!appState.settings.cuisine) appState.settings.cuisine = 'middle_eastern';
            
            // Logic for Views
            if(appState.user.onboarded && saved && sessionIntro) {
                document.querySelector('.bottom-nav').style.display = 'flex';
                document.getElementById('view-dashboard').classList.remove('hidden');
            }

            // Check if it's a new day, reset daily water
            const lastLogin = localStorage.getItem('lastLoginDate');
            const today = new Date().toDateString();
            if (lastLogin !== today) {
                appState.dailyWater = 0;
                localStorage.setItem('lastLoginDate', today);
                saveData();
            }

            // Set Inputs to current settings
            document.getElementById('setting-start-date').value = appState.settings.startDate;
            document.getElementById('setting-lat').value = appState.settings.lat;
            document.getElementById('setting-lng').value = appState.settings.lng;
            document.getElementById('setting-calc-method').value = appState.settings.calcMethod;
            document.getElementById('setting-cal-target').value = appState.settings.calTarget;
            document.getElementById('setting-prot-target').value = appState.settings.protTarget;

            // Render
            updateDateDisplay();
            // Only update prayer times if we have location
            if(appState.settings.lat && appState.settings.lng) {
                 updatePrayerTimes();
            } else {
                document.getElementById('location-display').innerText = "Location Not Set";
                document.getElementById('prayer-list').innerHTML = "<div class='text-center' style='padding:20px; color:var(--text-muted)'>Set location in Settings</div>";
            }
            
            renderDashboard();
            renderWaterTracker();
            renderFoodSuggestions();
            renderHistory();
            renderCalendar();
            
            // Random Tip
            document.getElementById('daily-tip-text').innerText = TIPS_DB[Math.floor(Math.random() * TIPS_DB.length)];

            // Setup Listeners
            setupFormListeners();

            // Start Ticker
            startTicker();
        }

        function playIntro(isNewUser) {
            const intro = document.getElementById('view-intro');
            intro.classList.remove('hidden');
            
            // Prevent scrolling during intro
            document.body.style.overflow = 'hidden';

            // Sequence Timing
            // Logo starts at 0.5s, Title at 1.2s, Sub at 1.8s, Progress at 2.2s
            // Progress finishes at 4.2s (2.2 + 2s duration)
            
            setTimeout(() => {
                // Fade out
                intro.style.animation = "fadeOutIntro 1s forwards";
                
                setTimeout(() => {
                    intro.classList.add('hidden');
                    document.body.style.overflow = '';
                    sessionStorage.setItem('introShown', 'true');
                    
                    if(isNewUser) {
                        setupOnboardingUI();
                    } else {
                        document.querySelector('.bottom-nav').style.display = 'flex';
                        document.getElementById('view-dashboard').classList.remove('hidden');
                    }
                }, 1000);
            }, 4500);
        }

        function checkInstallPrompt() {
            // Check if already in standalone mode
            const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            if (isStandalone) return;

            // Detect Mobile
            const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);

            if (isIos || isAndroid) {
                // Show guide after a short delay
                setTimeout(() => {
                    const modal = document.getElementById('install-modal');
                    const text = document.getElementById('install-instructions');
                    
                    if (isIos) {
                        text.innerHTML = "Tap <strong>Share</strong> <span style='font-size:1.2rem'>‚éã</span> then <strong>Add to Home Screen</strong> <span style='font-size:1.2rem'>‚ûï</span>";
                    } else {
                        text.innerHTML = "Tap <strong>Menu</strong> <span style='font-size:1.2rem'>‚ãÆ</span> then <strong>Install App</strong> or <strong>Add to Home Screen</strong>";
                    }
                    modal.classList.add('show');
                }, 5000);
            }
        }

        function closeInstallModal() {
            document.getElementById('install-modal').classList.remove('show');
        }

        function setupOnboardingUI() {
            document.getElementById('view-onboarding').classList.remove('hidden');
            document.getElementById('view-dashboard').classList.add('hidden');
            document.querySelector('.bottom-nav').style.display = 'none';
            
            document.getElementById('onboarding-form').addEventListener('submit', (e) => {
                e.preventDefault();
                finishOnboarding();
            });
        }

        function saveData() {
            localStorage.setItem('ramadanFitData', JSON.stringify(appState));
            renderDashboard(); // Re-render dash whenever data saves
        }

        // --- ONBOARDING & CALCULATOR ---
        function finishOnboarding() {
            // Validate Location
            const lat = document.getElementById('ob-lat').value;
            const lng = document.getElementById('ob-lng').value;
            
            if(!lat || !lng) {
                alert("Please set your location for accurate prayer times.");
                return;
            }

            // Get values
            appState.settings.lat = lat;
            appState.settings.lng = lng;
            appState.user.gender = document.getElementById('ob-gender').value;
            appState.user.age = parseInt(document.getElementById('ob-age').value);
            appState.user.height = parseInt(document.getElementById('ob-height').value);
            appState.user.weight = parseInt(document.getElementById('ob-weight').value);
            appState.user.activity = parseFloat(document.getElementById('ob-activity').value);
            appState.user.goal = parseInt(document.getElementById('ob-goal').value);
            
            // Calculate Macros (Mifflin-St Jeor)
            let bmr = 0;
            if(appState.user.gender === 'male') {
                bmr = (10 * appState.user.weight) + (6.25 * appState.user.height) - (5 * appState.user.age) + 5;
            } else {
                bmr = (10 * appState.user.weight) + (6.25 * appState.user.height) - (5 * appState.user.age) - 161;
            }
            
            const tdee = bmr * appState.user.activity;
            const targetCals = Math.round(tdee + appState.user.goal);
            
            // Protein: ~1.8g per kg bodyweight for active Ramadan maintenance
            const targetProt = Math.round(appState.user.weight * 1.8);

            appState.settings.calTarget = targetCals;
            appState.settings.protTarget = targetProt;
            appState.user.onboarded = true;
            
            saveData();
            // Refresh to Dashboard
            document.getElementById('view-onboarding').classList.add('hidden');
            document.querySelector('.bottom-nav').style.display = 'flex';
            document.getElementById('view-dashboard').classList.remove('hidden');
            updatePrayerTimes();
            renderDashboard();
            window.scrollTo(0,0);
        }

        // --- NAVIGATION & CORE ---
        function navTo(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Very simple active state mapping
            const btnIndex = ['view-dashboard','view-log-workout','view-log-meal','view-hydration','view-stats','view-settings'].indexOf(viewId);
            if(btnIndex >= 0) document.querySelectorAll('.nav-item')[btnIndex].classList.add('active');

            if (viewId === 'view-log-meal') renderFoodSuggestions();
            if (viewId === 'view-stats') { renderCalendar(); renderHistory(); }
            window.scrollTo(0,0);
        }

        function updateDateDisplay() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' });
            document.getElementById('date-display').innerText = dateStr;

            const start = new Date(appState.settings.startDate);
            const diffTime = Math.abs(now - start);
            const diffDays = Math.ceil((now - start) / (1000 * 60 * 60 * 24)); 
            
            // Logic for pre/during/post Ramadan
            let dayText = "PRE-RAMADAN";
            if (now >= start) {
                if (diffDays <= 30) dayText = `DAY ${diffDays + 1}`;
                else dayText = "EID MUBARAK";
            } else {
                dayText = `${Math.ceil((start - now) / (1000 * 60 * 60 * 24))} DAYS TO GO`;
            }
            document.getElementById('ramadan-day-badge').innerText = dayText;
        }

        function updatePrayerTimes() {
            if(!appState.settings.lat || !appState.settings.lng) return;

            const pt = new PrayTimes(appState.settings.calcMethod);
            pt.setAsrMethod(appState.settings.asrMethod || 'Standard');
            const now = new Date();
            // Offset for timezone (simple assumption: user's system time matches their location approximately or standard calc)
            const tz = -now.getTimezoneOffset() / 60; 
            currentPrayerTimes = pt.getTimes(now, parseFloat(appState.settings.lat), parseFloat(appState.settings.lng), tz);
            
            const pList = document.getElementById('prayer-list');
            pList.innerHTML = '';
            
            const list = [
                {key:'fajr', label:'Fajr (Suhoor Ends)'},
                {key:'dhuhr', label:'Dhuhr'},
                {key:'asr', label:'Asr'},
                {key:'maghrib', label:'Maghrib (Iftar)'},
                {key:'isha', label:'Isha'}
            ];

            // Determine next prayer
            const currentHour = now.getHours() + now.getMinutes()/60;
            let nextP = null;

            list.forEach(p => {
                const timeObj = currentPrayerTimes[p.key];
                const isNext = !nextP && timeObj.raw > currentHour;
                if(isNext) nextP = { ...p, time: timeObj.raw };
                
                pList.innerHTML += `
                    <div class="prayer-row ${isNext ? 'next' : ''}">
                        <span>${p.label}</span>
                        <span>${timeObj.display}</span>
                    </div>
                `;
            });
            
            // If no next prayer found today, next is Fajr tomorrow
            if(!nextP) {
                nextP = { key: 'fajr', label: 'Fajr (Tomorrow)', time: currentPrayerTimes.fajr.raw + 24 };
            }

            // Update Status Badge (Fasting / Eating)
            const badge = document.getElementById('fasting-status-badge');
            const fajrTime = currentPrayerTimes.fajr.raw;
            const maghribTime = currentPrayerTimes.maghrib.raw;

            if (currentHour >= fajrTime && currentHour < maghribTime) {
                badge.innerText = "FASTING";
                badge.style.background = "var(--primary)";
                badge.style.color = "#000";
            } else {
                badge.innerText = "EATING";
                badge.style.background = "var(--success)";
                badge.style.color = "#fff";
            }
            
            document.getElementById('location-display').innerText = `Location: ${parseFloat(appState.settings.lat).toFixed(2)}, ${parseFloat(appState.settings.lng).toFixed(2)}`;
            
            // Store target for ticker
            window.nextPrayerTarget = nextP;
        }

        function startTicker() {
            if(countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                if(!window.nextPrayerTarget || !currentPrayerTimes) return;

                const now = new Date();
                const currentH = now.getHours() + now.getMinutes()/60 + now.getSeconds()/3600;
                let diff = window.nextPrayerTarget.time - currentH;
                
                if(diff < 0) {
                    updatePrayerTimes(); // Refresh day/next prayer
                    return; 
                }

                // Format Countdown
                const h = Math.floor(diff);
                const m = Math.floor((diff - h) * 60);
                const s = Math.floor(((diff - h) * 60 - m) * 60);
                
                const str = `${h < 10 ? '0'+h : h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                document.getElementById('countdown-timer').innerText = str;
                
                // Label
                let label = "";
                if (window.nextPrayerTarget.key === 'maghrib') label = "UNTIL IFTAR";
                else if (window.nextPrayerTarget.key === 'fajr') label = "UNTIL SUHOOR ENDS";
                else label = `UNTIL ${window.nextPrayerTarget.label.toUpperCase()}`;
                
                document.getElementById('countdown-label').innerText = label;

            }, 1000);
        }

        // --- DASHBOARD RENDER ---
        function renderDashboard() {
            const todayStr = new Date().toDateString();
            
            // Calories
            const todayMeals = appState.logs.meals.filter(m => new Date(m.date).toDateString() === todayStr);
            const totalCals = todayMeals.reduce((acc, curr) => acc + parseInt(curr.cals), 0);
            const totalProt = todayMeals.reduce((acc, curr) => acc + parseInt(curr.prot), 0);
            
            document.getElementById('dash-cals').innerText = totalCals;
            const calPct = Math.min((totalCals / appState.settings.calTarget) * 100, 100);
            document.getElementById('dash-cal-circle').style.setProperty('--pct', `${calPct}%`);

            // Water
            document.getElementById('dash-water').innerText = appState.dailyWater.toFixed(1);
            const waterPct = Math.min((appState.dailyWater / 3.0) * 100, 100);
            document.getElementById('dash-water-circle').style.setProperty('--pct', `${waterPct}%`);

            // Workout
            const todayWorkout = appState.logs.workouts.find(w => new Date(w.date).toDateString() === todayStr);
            if (todayWorkout) {
                document.getElementById('dash-workout-status').innerText = "Completed ‚úÖ";
                document.getElementById('dash-workout-status').style.color = "var(--success)";
                document.getElementById('dash-energy').innerText = `${todayWorkout.energy}/10`;
            } else {
                document.getElementById('dash-workout-status').innerText = "Not Logged";
                document.getElementById('dash-workout-status').style.color = "var(--text-muted)";
                document.getElementById('dash-energy').innerText = "--/10";
            }

            // Update Meal Bars in Meal View
            document.getElementById('prog-cal-val').innerText = totalCals;
            document.getElementById('target-cal').innerText = appState.settings.calTarget;
            document.getElementById('prog-cal').style.width = `${calPct}%`;
            if(totalCals > appState.settings.calTarget) document.getElementById('prog-cal').classList.add('warning');
            else document.getElementById('prog-cal').classList.remove('warning');

            document.getElementById('prog-prot-val').innerText = totalProt;
            document.getElementById('target-prot').innerText = appState.settings.protTarget;
            document.getElementById('prog-prot').style.width = `${Math.min((totalProt/appState.settings.protTarget)*100, 100)}%`;

            // Render Meal Log List
            const logList = document.getElementById('meal-log-list');
            logList.innerHTML = '';
            todayMeals.slice().reverse().forEach(m => {
                logList.innerHTML += `
                    <div class="food-item">
                        <span><strong>${m.type}</strong>: ${m.name}</span>
                        <span>${m.cals}kcal</span>
                    </div>
                `;
            });
        }

        // --- FORMS & ACTIONS ---
        function addExerciseToText(ex) {
            if(!ex) return;
            const area = document.getElementById('w-notes');
            area.value = area.value ? area.value + `\n- ${ex}` : `- ${ex}`;
        }

        function setupFormListeners() {
            // Workout Form
            document.getElementById('workout-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const w = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    type: document.getElementById('w-type').value,
                    duration: document.getElementById('w-duration').value,
                    notes: document.getElementById('w-notes').value,
                    energy: document.getElementById('w-energy').value
                };
                appState.logs.workouts.push(w);
                saveData();
                document.getElementById('workout-form').reset();
                alert('Workout Saved!');
                renderHistory();
                renderDashboard();
            });

            // Meal Form
            document.getElementById('meal-form').addEventListener('submit', (e) => {
                e.preventDefault();
                addMeal({
                    type: document.getElementById('m-type').value,
                    name: document.getElementById('m-name').value,
                    cals: document.getElementById('m-cals').value,
                    prot: document.getElementById('m-prot').value
                });
                document.getElementById('m-name').value = '';
                document.getElementById('m-cals').value = '';
                document.getElementById('m-prot').value = '';
            });
        }

        function addMeal(mealObj) {
            const m = {
                id: Date.now(),
                date: new Date().toISOString(),
                ...mealObj
            };
            appState.logs.meals.push(m);
            saveData();
            renderDashboard(); // Updates progress bars
        }

        function renderFoodSuggestions() {
            const container = document.getElementById('food-suggestions');
            container.innerHTML = '';

            const foods = CUISINE_DATA[appState.settings.cuisine] || CUISINE_DATA['western'];

            foods.forEach(f => {
                const btn = document.createElement('button');
                btn.className = 'btn-outline';
                btn.style.flexShrink = '0';
                btn.style.fontSize = '0.8rem';
                btn.innerHTML = `${f.name}<br><span style="font-size:0.7rem">${f.cals}cal</span>`;
                btn.onclick = () => {
                    document.getElementById('m-name').value = f.name;
                    document.getElementById('m-cals').value = f.cals;
                    document.getElementById('m-prot').value = f.prot;
                };
                container.appendChild(btn);
            });
        }

        function locateMe() {
            if(!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                return;
            }
            navigator.geolocation.getCurrentPosition(position => {
                document.getElementById('setting-lat').value = position.coords.latitude;
                document.getElementById('setting-lng').value = position.coords.longitude;
                alert("Location Updated!");
            }, () => {
                alert("Unable to retrieve your location. Check permissions.");
            });
        }

        function locateMeOnboarding() {
            if(!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                return;
            }
            navigator.geolocation.getCurrentPosition(position => {
                document.getElementById('ob-lat').value = position.coords.latitude;
                document.getElementById('ob-lng').value = position.coords.longitude;
            }, () => {
                alert("Unable to retrieve your location. Please enter manually.");
            });
        }

        function saveSettings() {
            appState.settings.startDate = document.getElementById('setting-start-date').value;
            // appState.settings.cuisine = document.getElementById('setting-cuisine').value;
            
            appState.settings.lat = document.getElementById('setting-lat').value;
            appState.settings.lng = document.getElementById('setting-lng').value;
            appState.settings.calcMethod = document.getElementById('setting-calc-method').value;
            
            appState.settings.calTarget = parseInt(document.getElementById('setting-cal-target').value);
            appState.settings.protTarget = parseInt(document.getElementById('setting-prot-target').value);
            
            saveData();
            updateDateDisplay();
            updatePrayerTimes(); // Re-calc times
            alert('Settings Saved');
        }

        // --- HYDRATION ---
        function renderWaterTracker() {
            const container = document.getElementById('water-glasses');
            container.innerHTML = '';
            // 3 Liters = 12 x 250ml
            const totalGlasses = 12; 
            const glassesDrank = Math.floor(appState.dailyWater / 0.25);

            document.getElementById('hydro-liters').innerText = appState.dailyWater.toFixed(1);

            for(let i=0; i<totalGlasses; i++) {
                const glass = document.createElement('div');
                glass.className = `glass ${i < glassesDrank ? 'filled' : ''}`;
                glass.onclick = () => toggleGlass(i);
                container.appendChild(glass);
            }
        }

        function toggleGlass(idx) {
            const glassesDrank = Math.floor(appState.dailyWater / 0.25);
            if (idx >= glassesDrank) {
                appState.dailyWater += 0.25;
            } else {
                appState.dailyWater = Math.max(0, appState.dailyWater - 0.25);
            }
            saveData();
            renderWaterTracker();
        }

        function quickAddWater() {
            appState.dailyWater += 0.25;
            saveData();
            renderWaterTracker();
            alert("Added 250ml water");
        }

        function resetWater() {
            if(confirm('Reset water intake for today?')) {
                appState.dailyWater = 0;
                saveData();
                renderWaterTracker();
            }
        }

        // --- STATS & HISTORY ---
        function logWeight() {
            const w = document.getElementById('s-weight-input').value;
            if(!w) return;
            appState.logs.weight.push({date: new Date().toISOString(), val: w});
            saveData();
            renderHistory();
        }

        function renderHistory() {
            // Workouts
            const wList = document.getElementById('workout-history-list');
            wList.innerHTML = '';
            const recentW = appState.logs.workouts.slice().sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            if(recentW.length === 0) wList.innerHTML = '<p style="color:var(--text-muted)">No workouts yet.</p>';
            
            recentW.forEach(w => {
                const d = new Date(w.date);
                wList.innerHTML += `
                    <div style="background:var(--bg-dark); padding:10px; border-radius:8px; margin-bottom:10px; border-left:3px solid var(--primary);">
                        <div class="flex-between">
                            <strong>${w.type}</strong>
                            <span style="font-size:0.8rem; color:var(--text-muted)">${d.toLocaleDateString()}</span>
                        </div>
                        <div style="font-size:0.9rem; margin-top:5px;">${w.duration} mins ‚Ä¢ Energy: ${w.energy}/10</div>
                    </div>
                `;
            });

            // Weight
            const wgList = document.getElementById('weight-history');
            wgList.innerHTML = '<strong>Recent: </strong> ';
            const recentWg = appState.logs.weight.slice().reverse().slice(0, 5);
            recentWg.forEach(item => {
                wgList.innerHTML += `<span class="workout-tag">${item.val}kg</span>`;
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // Generate last 30 days
            for(let i=29; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toDateString();
                const dayNum = d.getDate();
                
                // Check if workout done
                const hasWorkout = appState.logs.workouts.some(w => new Date(w.date).toDateString() === dateStr);
                
                const cell = document.createElement('div');
                cell.style.aspectRatio = '1/1';
                cell.style.display = 'flex';
                cell.style.alignItems = 'center';
                cell.style.justifyContent = 'center';
                cell.style.borderRadius = '4px';
                cell.style.background = hasWorkout ? 'var(--primary)' : 'rgba(255,255,255,0.05)';
                cell.style.color = hasWorkout ? '#000' : 'var(--text-muted)';
                cell.innerText = dayNum;
                
                grid.appendChild(cell);
            }
        }

        // --- UTILS ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "ramadan_fitness_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function clearData() {
            if(confirm("Are you sure? This will delete all your logs.")) {
                localStorage.removeItem('ramadanFitData');
                location.reload();
            }
        }

        // Start
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>